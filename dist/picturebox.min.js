/*! Picture Box - v0.1.0 - 2013-09-27
* https://github.com/xixilive/picturebox
* Copyright (c) 2013 xixilive; Licensed MIT */
!function(a){"use strict";var b=function(b,c){this.$element=b,this.$viewport=this.$element.find(".viewport").html('<div class="loading"></div>'),this.$pictures=this.$element.find(".pictures"),this.pictures=a.map(a(".pictures li",this.$element),function(b){return a(b).data()}),this.options=c,this.position={x:0,y:0},this.intervalId=0,this.zoomStatus="out",this.currentIndex=parseInt(this.options.number,10)||0,this.viewportOffset=this.$viewport.offset(),this._init()};b.DEFAULTS={animation:200,number:0},b.prototype._init=function(){function b(){var a=[e.$viewport.innerWidth(),e.$viewport.innerHeight()],b=e.image[0];return{x:(a[0]-b.width)/2,y:(a[1]-b.height)/2}}function c(a){if(!e.loading){clearInterval(e.intervalId);var c=b(),f=e.moveToCoord(a.offsetX,a.offsetY);e.$viewport.css({backgroundPositionX:c.x,backgroundPositionY:c.y}).stop().animate({backgroundPositionX:f.x,backgroundPositionY:f.y},e.options.animation,function(){e.position=f,e.intervalId=setInterval(function(){e.$viewport.css({backgroundPositionX:e.position.x,backgroundPositionY:e.position.y})},20),e.$viewport.on("mousemove.pb",function(a){e.position=e.moveToCoord(a.offsetX,a.offsetY)}).on("mouseout.pb",d)})}}function d(){e.$viewport.off("mousemove.pb"),e.$viewport.off("mouseover.pb"),clearInterval(e.intervalId);var a=b();e.$viewport.stop().animate({backgroundPositionX:a.x,backgroundPositionY:a.y},e.options.animation,function(){e.$viewport.on("mouseover.pb",c)})}var e=this;e.moveToCoord=function(a,b){var c=e.image[0],d=[e.$viewport.innerWidth(),e.$viewport.innerHeight()],f=[c.width/d[0],c.height/d[1]];return{x:Math.min(-1*a*f[0]+d[0],0),y:Math.min(-1*b*f[1]+d[1],0)}},e.image=a("<img>").on("load",function(a){e.loading=!1,e.$viewport.find(".loading").stop().fadeOut(e.options.animation);var c=b();e.$viewport.css("background-image","url("+a.currentTarget.src+")").css({backgroundPositionX:c.x,backgroundPositionY:c.y})}).on("error",function(){e.loading=!1,e.$viewport.find(".loading").stop().fadeOut(e.options.animation)}),this.$pictures.find("li").each(function(){a(this).css("background-image","url("+a(this).data("thumb")+")").css({backgroundPositionX:"50%",backgroundPositionY:"50%"}).css("background-repeat","no-repeat")}),this.$viewport.on("mouseover.pb",c),this.slideTo(this.currentIndex)},b.prototype.slideTo=function(b){var c=this.pictures[b]&&this.pictures[b].src;c&&(this.loading=!0,this.$viewport.find(".loading").stop().fadeIn(this.options.animation),this.image.attr("src",this.pictures[b].src),this.currentIndex=b,a("li[data-thumb][data-src]",this.$pictures).removeClass("active"),a("li[data-thumb][data-src]:eq("+this.currentIndex+")",this.$pictures).addClass("active"))},b.prototype.slide=function(a){switch(a){case"prev":this.currentIndex>=1?this.slideTo(this.currentIndex-1):this.slideTo(this.pictures.length-1);break;case"next":this.currentIndex<this.pictures.length-1?this.slideTo(this.currentIndex+1):this.slideTo(0);break;default:this.slideTo(parseInt(a,10)||0)}},b.prototype.zoom=function(){"out"===this.zoomStatus?(this._resizeOverlay(!0),this.zoomStatus="in"):(this._resizeOverlay(!1),this.zoomStatus="out")},b.prototype._resizeOverlay=function(b){b?(a("body").css("overflow","hidden"),this.$element.addClass("zoomin").css({width:a(window).innerWidth(),height:a(window).innerHeight()}).offset({top:a("body").scrollTop(),left:0})):(a("body").css("overflow","auto"),this.$element.css({width:"auto",height:"auto"}).removeClass("zoomin"))};var c=a.fn.pictureBox;a.fn.pictureBox=function(c){return this.each(function(){var d=a(this),e=d.data("pictureBox");if(!e){var f=d.data()||b.DEFAULTS;a.extend(f,"object"==typeof c&&c),d.data("pictureBox",e=new b(d,f))}})},a.fn.pictureBox.noConflict=function(){return a.fn.pictureBox=c,this},a(document).on("click.picturebox.toolbar","[data-slide], [data-zoom]",function(b){b.preventDefault();var c=a(this),d=c.data(),e=(d.target||c.attr("href")||"").replace("#",""),f=a("#"+e).data("pictureBox");return f?d.slide?(f.slide(d.slide),void 0):d.zoom?(f.zoom(),void 0):void 0:void 0}),a(document).on("click.picturebox.slide",".pictures li[data-thumb][data-src]",function(b){var c=a(b.currentTarget),d=c.closest(".picture-box").data("pictureBox");d&&d.slide(c.index())}),a(document).on("keydown.picturebox",function(b){var c=a(".picture-box").data("pictureBox");c&&((27===b.which&&"in"===c.zoomStatus||192===b.which&&"out"===c.zoomStatus)&&c.zoom(),(37===b.which||38===b.which)&&c.slide("prev"),(39===b.which||40===b.which)&&c.slide("next"))}),a(window).on("resize.picture.zoomin",function(){var b=a(".picture-box.zoomin").data("pictureBox");b&&b._resizeOverlay(!0)}),a(function(){a(".picture-box").pictureBox()})}(window.jQuery);